import{_ as W,a5 as L,o as B,c as C,a as s,w as n,N as E,H,F as R,f as g,b as p,j as D,V as F,e as N,h as O,I as M,J as Y}from"./main-2bc8bdc8.js";import{m as v}from"./axios-379d51f3.js";import{i as z,P as X}from"./PDFButton-7c8ea9bb.js";import{V as G,a as J,c as q,b as K}from"./VCard-c4499485.js";import{V as Q}from"./VRow-81b2c681.js";import{V as Z}from"./VSelect-7b794d0f.js";import{V as tt}from"./VFileInput-eb8b9aa4.js";import"./VAvatar-0fecf93b.js";import"./VImg-5fa0cdd5.js";import"./VTextField-c45a6af8.js";import"./VInput-d921ae59.js";import"./index-2b714cf9.js";import"./forwardRefs-8348545e.js";import"./VMenu-bd444189.js";import"./dialog-transition-d72eed50.js";import"./VChip-8caff782.js";const et={name:"PdfViewer",data(){return{overlay:!1,signature:null,pdf:null,interactable:null,users:[],selectedUser:null,filePath:this.$filePath,detailAttach:null}},methods:{goBack(){this.$router.go(-1)},async renderPDF(e){const t=await L(()=>import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.mjs"),[]);if(t.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs",!!e)try{const a=await fetch(e);if(!a.ok)throw new Error(`Failed to fetch PDF: ${a.statusText}`);const i=await a.arrayBuffer(),o=await t.getDocument(i).promise,r=this.$refs.pdfContainer;r.innerHTML="";const w=(await o.getPage(1)).getViewport({scale:1}),y=r.clientWidth/w.width;for(let u=1;u<=o.numPages;u++){const _=await o.getPage(u),d=_.getViewport({scale:y}),h=document.createElement("canvas"),P=h.getContext("2d");h.height=d.height,h.width=d.width;const b={canvasContext:P,viewport:d};await _.render(b).promise,r.appendChild(h)}}catch(a){console.error("Error rendering PDF:",a)}},handleFileUpload(e){const t=e.target.files[0];t&&(this.signature=URL.createObjectURL(t))},initSignaturePosition(){const e=this.$refs.signatureImage;this.interactable=z(e).draggable({onmove:this.dragMoveListener}).resizable({edges:{left:!0,right:!0,bottom:!0,top:!0},listeners:{move(t){let{x:a,y:i}=t.target.dataset;a=(parseFloat(a)||0)+t.deltaRect.left,i=(parseFloat(i)||0)+t.deltaRect.top,Object.assign(t.target.style,{width:`${t.rect.width}px`,height:`${t.rect.height}px`,transform:`translate(${a}px, ${i}px)`}),t.target.dataset.x=a,t.target.dataset.y=i}}})},dragMoveListener(e){const t=e.target,a=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,i=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.transform=`translate(${a}px, ${i}px)`,t.setAttribute("data-x",a),t.setAttribute("data-y",i)},async getPdfArrayBuffer(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch PDF: ${t.statusText}`);return await t.arrayBuffer()},async savePDF(){if(!this.signature){alert("Upload tanda tangan terlebih dahulu");return}const e=this.$refs.signatureImage,t=parseFloat(e.getAttribute("data-x"))||0,a=parseFloat(e.getAttribute("data-y"))||0,i=e.width,l=e.height,o=await this.getPdfArrayBuffer(this.filePath+"/"+this.detailAttach.file_id+"/"+this.detailAttach.path),r=await X.load(o),k=await this.getPdfArrayBuffer(this.signature),w=await r.embedPng(k),y=this.$refs.pdfContainer.clientWidth,d=(await r.getPage(0)).getWidth()/y,h=t*d,P=a*d,b=i*d,A=l*d;let m=null,x=P;const U=r.getPages();for(const f of U){const c=f.getHeight();if(x<=c){m=f;break}x-=c}if(!m){alert("Error, Tanda tangan di tempatkan di luar halaman terakhir");return}let I=m.getHeight()-x-A;m.drawImage(w,{x:h,y:I,width:b,height:A});const S=await r.save(),j=new Blob([S],{type:"application/pdf"});try{this.overlay=!0;const f=this.$route.params.idAttach,c=new FormData;c.append("user_id",this.selectedUser),c.append("doc",new File([j],this.detailAttach.path,{type:"application/pdf"})),c.append("_method","PUT");const V=await v.post(`signature/${f}`,c);V.status===200?(this.overlay=!1,this.$showToast("success","Success",V.data.message),this.goBack()):(this.overlay=!1,this.$showToast("error","Sorry",V.data.data.message))}catch{this.overlay=!1,window.location.reload(),this.$showToast("error","Error","Failed to update the signed document")}},async getDetailAttach(){try{this.overlay=!0;const e=this.$route.params.idAttach,t=await v.get(`/user/get-attach/${e}`);t.status==200?(this.detailAttach=t.data.data,await this.renderPDF(this.filePath+"/"+this.detailAttach.file_id+"/"+this.detailAttach.path),this.overlay=!1):(this.$showToast("error","Sorry",t.data.data.message),this.overlay=!1)}catch(e){this.$showToast("error","Sorry",e.response.data.message),this.overlay=!1}},async getUser(){try{const e=this.$route.params.idAttach,t=await v.get(`/list-approval/${e}`);t.status===200&&(this.users=t.data.data.map(a=>({value:a.user.id,title:a.user.name})))}catch(e){console.log(e)}}},async mounted(){await this.getDetailAttach(),await this.getUser()}},T=e=>(M("data-v-8d3e3999"),e=e(),Y(),e),at=T(()=>p("span",{style:{color:"red"}},"*",-1)),st=T(()=>p("span",{class:"subtitle-1 text-center"},"Pilih User: ",-1)),rt=T(()=>p("span",{class:"subtitle-1 text-center"},[p("span",{style:{color:"red"}},"*"),g(" File Tanda Tangan (format png): ")],-1)),it={class:"pdf-viewer",ref:"pdfContainer"},ot=["src"];function nt(e,t,a,i,l,o){return B(),C(H,null,[s(E,{"model-value":l.overlay,class:"align-center justify-center"},{default:n(()=>[s(R,{color:"blue-lighten-3",indeterminate:"",size:41,width:5}),g(" Loading... ")]),_:1},8,["model-value"]),s(G,{class:"pa-2"},{default:n(()=>[s(J,{class:"align-left"},{default:n(()=>[p("span",{color:"primary",onClick:t[0]||(t[0]=(...r)=>o.goBack&&o.goBack(...r)),style:{cursor:"pointer"}},[s(D,{icon:"bx-arrow-back",color:"primary",tag:"back",start:""}),g(" Back ")]),s(q,{class:"text-2xl font-weight-bold"},{default:n(()=>[g(" Tanda Tangan ")]),_:1})]),_:1}),s(K,null,{default:n(()=>[s(Q,{class:"mt-4 mb-4"},{default:n(()=>[s(F,{md:"12",cols:"12"},{default:n(()=>[at,st,s(Z,{items:l.users,autofocus:"",modelValue:l.selectedUser,"onUpdate:modelValue":t[1]||(t[1]=r=>l.selectedUser=r),"prepend-icon":"mdi-help-rhombus"},null,8,["items","modelValue"])]),_:1}),s(F,{md:"12",cols:"6"},{default:n(()=>[rt,s(tt,{label:"Upload Tanda Tangan",accept:"image/png","prepend-icon":"mdi-image",outlined:"",dense:"",onChange:o.handleFileUpload},null,8,["onChange"])]),_:1}),s(F,{md:"12",cols:"6",class:"d-flex justify-end"},{default:n(()=>[s(N,{color:"primary",onClick:o.savePDF},{default:n(()=>[s(D,{left:""},{default:n(()=>[g("mdi-file-pdf-box")]),_:1}),g(" Simpan PDF dengan Tanda Tangan ")]),_:1},8,["onClick"])]),_:1})]),_:1}),p("div",it,[l.signature?(B(),C("img",{key:0,ref:"signatureImage",src:l.signature,class:"signature",onLoad:t[2]||(t[2]=(...r)=>o.initSignaturePosition&&o.initSignaturePosition(...r))},null,40,ot)):O("",!0)],512)]),_:1})]),_:1})],64)}const Ft=W(et,[["render",nt],["__scopeId","data-v-8d3e3999"]]);export{Ft as default};
