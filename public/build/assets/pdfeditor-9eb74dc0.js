import{a3 as W,o as B,c as v,a as r,w as n,G as E,E as S,e as g,b as p,i as A,V as U,f as R,H,I as O}from"./main-e5f72558.js";import{m as N}from"./VGrid-35f055f5.js";import{i as M,P as Y}from"./PDFButton-1d235294.js";import{_ as z}from"./_plugin-vue_export-helper-c27b6911.js";import{V as G}from"./VOverlay-8ac1af85.js";import{V as X,a as q,e as J,b as K,c as Q,d as C}from"./VRow-7c17c466.js";import{V as Z}from"./VFileInput-872c6bdc.js";import"./VImg-6394f2a2.js";import"./VInput-a3833843.js";import"./index-a9df6efe.js";import"./VChip-c285a843.js";const tt={name:"PdfViewer",data(){return{overlay:!1,signature:null,pdf:null,interactable:null,filePath:this.$filePath,detailAttach:null}},methods:{goBack(){this.$router.go(-1)},async renderPDF(e){const t=await W(()=>import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.mjs"),[]);if(t.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs",!!e)try{const a=await fetch(e);if(!a.ok)throw new Error(`Failed to fetch PDF: ${a.statusText}`);const s=await a.arrayBuffer(),i=await t.getDocument(s).promise,o=this.$refs.pdfContainer;o.innerHTML="";const u=(await i.getPage(1)).getViewport({scale:1}),m=o.clientWidth/u.width;for(let f=1;f<=i.numPages;f++){const w=await i.getPage(f),d=w.getViewport({scale:m}),c=document.createElement("canvas"),y=c.getContext("2d");c.height=d.height,c.width=d.width;const _={canvasContext:y,viewport:d};await w.render(_).promise,o.appendChild(c)}}catch(a){console.error("Error rendering PDF:",a)}},handleFileUpload(e){const t=e.target.files[0];t&&(this.signature=URL.createObjectURL(t))},initSignaturePosition(){const e=this.$refs.signatureImage;this.interactable=M(e).draggable({onmove:this.dragMoveListener}).resizable({edges:{left:!0,right:!0,bottom:!0,top:!0},listeners:{move(t){let{x:a,y:s}=t.target.dataset;a=(parseFloat(a)||0)+t.deltaRect.left,s=(parseFloat(s)||0)+t.deltaRect.top,Object.assign(t.target.style,{width:`${t.rect.width}px`,height:`${t.rect.height}px`,transform:`translate(${a}px, ${s}px)`}),t.target.dataset.x=a,t.target.dataset.y=s}}})},dragMoveListener(e){const t=e.target,a=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,s=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.transform=`translate(${a}px, ${s}px)`,t.setAttribute("data-x",a),t.setAttribute("data-y",s)},async getPdfArrayBuffer(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch PDF: ${t.statusText}`);return await t.arrayBuffer()},async savePDF(){if(!this.signature){alert("Upload tanda tangan terlebih dahulu");return}const e=this.$refs.signatureImage,t=parseFloat(e.getAttribute("data-x"))||0,a=parseFloat(e.getAttribute("data-y"))||0,s=e.width,l=e.height,i=await this.getPdfArrayBuffer(this.filePath+"/"+this.detailAttach.file_id+"/"+this.detailAttach.path),o=await Y.load(i),x=await this.getPdfArrayBuffer(this.signature),u=await o.embedPng(x),m=this.$refs.pdfContainer.clientWidth,d=(await o.getPage(0)).getWidth()/m,c=t*d,y=a*d,_=s*d,k=l*d;let h=null,P=y;const D=o.getPages();for(const V of D){const F=V.getHeight();if(P<=F){h=V;break}P-=F}if(!h){alert("Error, Tanda tangan di tempatkan di luar halaman terakhir");return}let I=h.getHeight()-P-k;h.drawImage(u,{x:c,y:I,width:_,height:k});const $=await o.save(),L=new Blob([$],{type:"application/pdf"}),j=URL.createObjectURL(L),b=document.createElement("a");b.href=j,b.download=this.detailAttach.path,b.click(),this.goBack()},async getDetailAttach(){try{this.overlay=!0;const e=this.$route.params.idAttach,t=await N.get(`/get-attach/${e}`);t.status==200?(this.detailAttach=t.data.data,await this.renderPDF(this.filePath+"/"+this.detailAttach.file_id+"/"+this.detailAttach.path),this.overlay=!1):(this.$showToast("error","Sorry",t.data.data.message),this.overlay=!1)}catch(e){this.$showToast("error","Sorry",e.response.data.message),this.overlay=!1}}},async mounted(){await this.getDetailAttach()}},et=e=>(H("data-v-248d99d1"),e=e(),O(),e),at=et(()=>p("span",{class:"subtitle-1 text-center"},[p("span",{style:{color:"red"}},"*"),g(" File Tanda Tangan (format png): ")],-1)),rt={class:"pdf-viewer",ref:"pdfContainer"},st=["src"];function it(e,t,a,s,l,i){return B(),v(E,null,[r(G,{"model-value":l.overlay,class:"align-center justify-center"},{default:n(()=>[r(S,{color:"blue-lighten-3",indeterminate:"",size:41,width:5}),g(" Loading... ")]),_:1},8,["model-value"]),r(X,null,{default:n(()=>[r(q,{class:"align-left"},{default:n(()=>[p("span",{color:"primary",onClick:t[0]||(t[0]=(...o)=>i.goBack&&i.goBack(...o)),style:{cursor:"pointer"}},[r(A,{icon:"bx-arrow-back",color:"primary",tag:"back",start:""}),g(" Back ")]),r(J,{class:"text-2xl font-weight-bold"},{default:n(()=>[g(" Tanda Tangan ")]),_:1})]),_:1}),r(K,null,{default:n(()=>[r(Q,{class:"mt-4 mb-4"},{default:n(()=>[r(C,{md:"12",cols:"6"},{default:n(()=>[at,r(Z,{label:"Upload Tanda Tangan",accept:"image/png","prepend-icon":"mdi-image",outlined:"",dense:"",onChange:i.handleFileUpload},null,8,["onChange"])]),_:1}),r(C,{md:"12",cols:"6",class:"d-flex justify-end"},{default:n(()=>[r(U,{color:"primary",onClick:i.savePDF},{default:n(()=>[r(A,{left:""},{default:n(()=>[g("mdi-file-pdf-box")]),_:1}),g(" Simpan PDF dengan Tanda Tangan ")]),_:1},8,["onClick"])]),_:1})]),_:1}),p("div",rt,[l.signature?(B(),v("img",{key:0,ref:"signatureImage",src:l.signature,class:"signature",onLoad:t[1]||(t[1]=(...o)=>i.initSignaturePosition&&i.initSignaturePosition(...o))},null,40,st)):R("",!0)],512)]),_:1})]),_:1})],64)}const wt=z(tt,[["render",it],["__scopeId","data-v-248d99d1"]]);export{wt as default};
