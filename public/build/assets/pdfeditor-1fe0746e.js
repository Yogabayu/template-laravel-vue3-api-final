import{a3 as j,o as B,c as C,a as s,w as n,G as E,E as L,e as g,b as p,i as D,V as H,f as R,H as O,I as N}from"./main-b95079ee.js";import{m as v}from"./VGrid-339e33a6.js";import{i as M,P as Y}from"./PDFButton-e3db5369.js";import{_ as z}from"./_plugin-vue_export-helper-c27b6911.js";import{V as G}from"./VOverlay-0ec5b778.js";import{V as X,a as q,d as J,b as K,c as F}from"./VCol-538157a7.js";import{V as Q}from"./VRow-66913789.js";import{V as Z}from"./VSelect-77e8b86a.js";import{V as tt}from"./VFileInput-81bcbc8c.js";import"./VImg-c54e4b59.js";import"./VTextField-974fa2d4.js";import"./VInput-8588e264.js";import"./index-e5c66add.js";import"./VMenu-08dac463.js";import"./dialog-transition-f5dc2016.js";import"./VChip-c2edb612.js";const et={name:"PdfViewer",data(){return{overlay:!1,signature:null,pdf:null,interactable:null,users:[],selectedUser:null,filePath:this.$filePath,detailAttach:null}},methods:{goBack(){this.$router.go(-1)},async renderPDF(e){const t=await j(()=>import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.mjs"),[]);if(t.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs",!!e)try{const a=await fetch(e);if(!a.ok)throw new Error(`Failed to fetch PDF: ${a.statusText}`);const i=await a.arrayBuffer(),o=await t.getDocument(i).promise,r=this.$refs.pdfContainer;r.innerHTML="";const w=(await o.getPage(1)).getViewport({scale:1}),y=r.clientWidth/w.width;for(let u=1;u<=o.numPages;u++){const _=await o.getPage(u),d=_.getViewport({scale:y}),h=document.createElement("canvas"),P=h.getContext("2d");h.height=d.height,h.width=d.width;const b={canvasContext:P,viewport:d};await _.render(b).promise,r.appendChild(h)}}catch(a){console.error("Error rendering PDF:",a)}},handleFileUpload(e){const t=e.target.files[0];t&&(this.signature=URL.createObjectURL(t))},initSignaturePosition(){const e=this.$refs.signatureImage;this.interactable=M(e).draggable({onmove:this.dragMoveListener}).resizable({edges:{left:!0,right:!0,bottom:!0,top:!0},listeners:{move(t){let{x:a,y:i}=t.target.dataset;a=(parseFloat(a)||0)+t.deltaRect.left,i=(parseFloat(i)||0)+t.deltaRect.top,Object.assign(t.target.style,{width:`${t.rect.width}px`,height:`${t.rect.height}px`,transform:`translate(${a}px, ${i}px)`}),t.target.dataset.x=a,t.target.dataset.y=i}}})},dragMoveListener(e){const t=e.target,a=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,i=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.transform=`translate(${a}px, ${i}px)`,t.setAttribute("data-x",a),t.setAttribute("data-y",i)},async getPdfArrayBuffer(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch PDF: ${t.statusText}`);return await t.arrayBuffer()},async savePDF(){if(!this.signature){alert("Upload tanda tangan terlebih dahulu");return}const e=this.$refs.signatureImage,t=parseFloat(e.getAttribute("data-x"))||0,a=parseFloat(e.getAttribute("data-y"))||0,i=e.width,l=e.height,o=await this.getPdfArrayBuffer(this.filePath+"/"+this.detailAttach.file_id+"/"+this.detailAttach.path),r=await Y.load(o),k=await this.getPdfArrayBuffer(this.signature),w=await r.embedPng(k),y=this.$refs.pdfContainer.clientWidth,d=(await r.getPage(0)).getWidth()/y,h=t*d,P=a*d,b=i*d,A=l*d;let m=null,x=P;const U=r.getPages();for(const f of U){const c=f.getHeight();if(x<=c){m=f;break}x-=c}if(!m){alert("Error, Tanda tangan di tempatkan di luar halaman terakhir");return}let I=m.getHeight()-x-A;m.drawImage(w,{x:h,y:I,width:b,height:A});const S=await r.save(),W=new Blob([S],{type:"application/pdf"});try{this.overlay=!0;const f=this.$route.params.idAttach,c=new FormData;c.append("user_id",this.selectedUser),c.append("doc",new File([W],this.detailAttach.path,{type:"application/pdf"})),c.append("_method","PUT");const V=await v.post(`signature/${f}`,c);V.status===200?(this.overlay=!1,this.$showToast("success","Success",V.data.message),this.goBack()):(this.overlay=!1,this.$showToast("error","Sorry",V.data.data.message))}catch{this.overlay=!1,window.location.reload(),this.$showToast("error","Error","Failed to update the signed document")}},async getDetailAttach(){try{this.overlay=!0;const e=this.$route.params.idAttach,t=await v.get(`/user/get-attach/${e}`);t.status==200?(this.detailAttach=t.data.data,await this.renderPDF(this.filePath+"/"+this.detailAttach.file_id+"/"+this.detailAttach.path),this.overlay=!1):(this.$showToast("error","Sorry",t.data.data.message),this.overlay=!1)}catch(e){this.$showToast("error","Sorry",e.response.data.message),this.overlay=!1}},async getUser(){try{const e=this.$route.params.idAttach,t=await v.get(`/list-approval/${e}`);t.status===200&&(this.users=t.data.data.map(a=>({value:a.user.id,title:a.user.name})))}catch(e){console.log(e)}}},async mounted(){await this.getDetailAttach(),await this.getUser()}},T=e=>(O("data-v-8d3e3999"),e=e(),N(),e),at=T(()=>p("span",{style:{color:"red"}},"*",-1)),st=T(()=>p("span",{class:"subtitle-1 text-center"},"Pilih User: ",-1)),rt=T(()=>p("span",{class:"subtitle-1 text-center"},[p("span",{style:{color:"red"}},"*"),g(" File Tanda Tangan (format png): ")],-1)),it={class:"pdf-viewer",ref:"pdfContainer"},ot=["src"];function nt(e,t,a,i,l,o){return B(),C(E,null,[s(G,{"model-value":l.overlay,class:"align-center justify-center"},{default:n(()=>[s(L,{color:"blue-lighten-3",indeterminate:"",size:41,width:5}),g(" Loading... ")]),_:1},8,["model-value"]),s(X,{class:"pa-2"},{default:n(()=>[s(q,{class:"align-left"},{default:n(()=>[p("span",{color:"primary",onClick:t[0]||(t[0]=(...r)=>o.goBack&&o.goBack(...r)),style:{cursor:"pointer"}},[s(D,{icon:"bx-arrow-back",color:"primary",tag:"back",start:""}),g(" Back ")]),s(J,{class:"text-2xl font-weight-bold"},{default:n(()=>[g(" Tanda Tangan ")]),_:1})]),_:1}),s(K,null,{default:n(()=>[s(Q,{class:"mt-4 mb-4"},{default:n(()=>[s(F,{md:"12",cols:"12"},{default:n(()=>[at,st,s(Z,{items:l.users,autofocus:"",modelValue:l.selectedUser,"onUpdate:modelValue":t[1]||(t[1]=r=>l.selectedUser=r),"prepend-icon":"mdi-help-rhombus"},null,8,["items","modelValue"])]),_:1}),s(F,{md:"12",cols:"6"},{default:n(()=>[rt,s(tt,{label:"Upload Tanda Tangan",accept:"image/png","prepend-icon":"mdi-image",outlined:"",dense:"",onChange:o.handleFileUpload},null,8,["onChange"])]),_:1}),s(F,{md:"12",cols:"6",class:"d-flex justify-end"},{default:n(()=>[s(H,{color:"primary",onClick:o.savePDF},{default:n(()=>[s(D,{left:""},{default:n(()=>[g("mdi-file-pdf-box")]),_:1}),g(" Simpan PDF dengan Tanda Tangan ")]),_:1},8,["onClick"])]),_:1})]),_:1}),p("div",it,[l.signature?(B(),C("img",{key:0,ref:"signatureImage",src:l.signature,class:"signature",onLoad:t[2]||(t[2]=(...r)=>o.initSignaturePosition&&o.initSignaturePosition(...r))},null,40,ot)):R("",!0)],512)]),_:1})]),_:1})],64)}const vt=z(et,[["render",nt],["__scopeId","data-v-8d3e3999"]]);export{vt as default};
